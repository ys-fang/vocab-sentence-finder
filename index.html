<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VocabGem - 學測英文詞彙例句寶庫</title>
    
    <!-- Google Material Design 3 (Material You) -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet">
    
    <!-- SheetJS library for Excel file generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- docx library for Word file generation -->
    <script src="https://cdn.jsdelivr.net/npm/docx@7.8.2/build/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    
    <!-- compromise.js library for English NLP -->
    <script src="https://unpkg.com/compromise@latest/builds/compromise.min.js"></script>
    <style>
        /* Jutor.ai 真實配色方案 v2 - 更簡潔的詮釋 */
        :root {
            /* Primary Colors - Jutor 薄荷綠主色調 */
            --md-sys-color-primary: #5DBEAA;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #F0FAF9;
            --md-sys-color-on-primary-container: #2D3748;

            /* Secondary Colors - 深灰色系 for text and UI elements */
            --md-sys-color-secondary: #4A5568;
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #F1F5F9;
            --md-sys-color-on-secondary-container: #1A202C;

            /* Tertiary Colors - 輔助藍色系 from screenshot */
            --md-sys-color-tertiary: #4299E1;
            --md-sys-color-on-tertiary: #FFFFFF;
            --md-sys-color-tertiary-container: #EBF8FF;
            --md-sys-color-on-tertiary-container: #2B6CB0;

            /* Error Colors */
            --md-sys-color-error: #E53E3E;
            --md-sys-color-on-error: #FFFFFF;
            --md-sys-color-error-container: #FFF5F5;
            --md-sys-color-on-error-container: #9B2C2C;

            /* Surface Colors - Clean & white */
            --md-sys-color-surface: #FFFFFF;
            --md-sys-color-on-surface: #2D3748;
            --md-sys-color-surface-variant: #F7FAFC;
            --md-sys-color-on-surface-variant: #718096;
            --md-sys-color-surface-container: #FFFFFF;
            --md-sys-color-surface-container-low: #F7FAFC;
            --md-sys-color-surface-container-lowest: #FFFFFF;
            --md-sys-color-surface-container-high: #F7FAFC;
            --md-sys-color-surface-container-highest: #EDF2F7;

            /* Outline Colors */
            --md-sys-color-outline: #E2E8F0;
            --md-sys-color-outline-variant: #F1F5F9;

            /* Success Colors */
            --md-sys-color-success: #38A169;
            --md-sys-color-on-success: #FFFFFF;
            --md-sys-color-success-container: #F0FFF4;
            --md-sys-color-on-success-container: #276749;

            /* Warning Colors */
            --md-sys-color-warning: #D69E2E;
            --md-sys-color-on-warning: #FFFFFF;
            --md-sys-color-warning-container: #FFFAF0;
            --md-sys-color-on-warning-container: #975A16;

            /* Elevations */
            --md-sys-elevation-level0: 0px 0px 0px 0px rgba(0, 0, 0, 0.00), 0px 0px 0px 0px rgba(0, 0, 0, 0.00);
            --md-sys-elevation-level1: 0px 1px 2px 0px rgba(0, 0, 0, 0.30), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
            --md-sys-elevation-level2: 0px 1px 2px 0px rgba(0, 0, 0, 0.30), 0px 2px 6px 2px rgba(0, 0, 0, 0.15);
            --md-sys-elevation-level3: 0px 4px 8px 3px rgba(0, 0, 0, 0.15), 0px 1px 3px 0px rgba(0, 0, 0, 0.30);
            --md-sys-elevation-level4: 0px 6px 10px 4px rgba(0, 0, 0, 0.15), 0px 2px 3px 0px rgba(0, 0, 0, 0.30);
            --md-sys-elevation-level5: 0px 8px 12px 6px rgba(0, 0, 0, 0.15), 0px 4px 4px 0px rgba(0, 0, 0, 0.30);

            /* Typography Scale */
            --md-sys-typescale-display-large-size: 57px;
            --md-sys-typescale-display-large-line-height: 64px;
            --md-sys-typescale-display-large-weight: 400;

            --md-sys-typescale-headline-large-size: 32px;
            --md-sys-typescale-headline-large-line-height: 40px;
            --md-sys-typescale-headline-large-weight: 400;

            --md-sys-typescale-title-large-size: 22px;
            --md-sys-typescale-title-large-line-height: 28px;
            --md-sys-typescale-title-large-weight: 400;

            --md-sys-typescale-title-medium-size: 16px;
            --md-sys-typescale-title-medium-line-height: 24px;
            --md-sys-typescale-title-medium-weight: 500;

            --md-sys-typescale-body-large-size: 16px;
            --md-sys-typescale-body-large-line-height: 24px;
            --md-sys-typescale-body-large-weight: 400;

            --md-sys-typescale-body-medium-size: 14px;
            --md-sys-typescale-body-medium-line-height: 20px;
            --md-sys-typescale-body-medium-weight: 400;

            --md-sys-typescale-body-small-size: 12px;
            --md-sys-typescale-body-small-line-height: 16px;
            --md-sys-typescale-body-small-weight: 400;

            --md-sys-typescale-label-large-size: 14px;
            --md-sys-typescale-label-large-line-height: 20px;
            --md-sys-typescale-label-large-weight: 500;

            /* Spacing System */
            --md-sys-spacing-xs: 4px;
            --md-sys-spacing-sm: 8px;
            --md-sys-spacing-md: 16px;
            --md-sys-spacing-lg: 24px;
            --md-sys-spacing-xl: 32px;
            --md-sys-spacing-xxl: 48px;

            /* Compact Mode Spacing - 緊湊模式間距 */
            --md-sys-compact-spacing-xs: 2px;
            --md-sys-compact-spacing-sm: 4px;
            --md-sys-compact-spacing-md: 8px;
            --md-sys-compact-spacing-lg: 12px;
            --md-sys-compact-spacing-xl: 16px;
            --md-sys-compact-spacing-xxl: 24px;

            /* Border Radius */
            --md-sys-shape-corner-none: 0px;
            --md-sys-shape-corner-extra-small: 4px;
            --md-sys-shape-corner-small: 8px;
            --md-sys-shape-corner-medium: 12px;
            --md-sys-shape-corner-large: 16px;
            --md-sys-shape-corner-extra-large: 28px;
            --md-sys-shape-corner-full: 50%;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--md-sys-color-surface-container-low);
            color: var(--md-sys-color-on-surface);
            min-height: 100vh;
            padding: var(--md-sys-spacing-md);
            font-size: var(--md-sys-typescale-body-large-size);
            line-height: var(--md-sys-typescale-body-large-line-height);
            font-weight: var(--md-sys-typescale-body-large-weight);
        }

        /* Material Icons 全域樣式 */
        .material-icons,
        .material-icons-outlined,
        .material-symbols-outlined {
            font-family: 'Material Symbols Outlined', 'Material Icons Outlined', 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 20px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
            vertical-align: middle;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--md-sys-color-surface-container-lowest);
            border-radius: var(--md-sys-shape-corner-extra-large);
            box-shadow: var(--md-sys-elevation-level2);
        }

        .header {
            background: var(--md-sys-color-surface-container-low);
            color: var(--md-sys-color-on-surface);
            padding: var(--md-sys-spacing-xxl) var(--md-sys-spacing-xl);
            text-align: center;
            position: relative;
            overflow: hidden;
            border-radius: var(--md-sys-shape-corner-extra-large) var(--md-sys-shape-corner-extra-large) 0 0;
        }

        .header::before {
            display: none;
        }

        .header h1 {
            font-size: var(--md-sys-typescale-headline-large-size);
            line-height: var(--md-sys-typescale-headline-large-line-height);
            font-weight: var(--md-sys-typescale-headline-large-weight);
            margin-bottom: var(--md-sys-spacing-sm);
            position: relative;
            z-index: 1;
            color: var(--md-sys-color-primary);
        }

        .header p {
            font-size: var(--md-sys-typescale-body-large-size);
            line-height: var(--md-sys-typescale-body-large-line-height);
            opacity: 0.87;
            position: relative;
            z-index: 1;
            color: var(--md-sys-color-on-surface-variant);
        }

        .controls {
            position: sticky;
            top: 0;
            z-index: 100;
            padding: var(--md-sys-spacing-xl);
            background: var(--md-sys-color-surface);
            border-bottom: 1px solid var(--md-sys-color-outline);
            box-shadow: none;
            transition: all 0.3s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        .controls.scrolled {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom-color: transparent;
            box-shadow: var(--md-sys-elevation-level2);
        }

        .search-section {
            display: flex;
            gap: var(--md-sys-spacing-md);
            margin-bottom: var(--md-sys-spacing-lg);
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: var(--md-sys-spacing-md) var(--md-sys-spacing-lg);
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--md-sys-shape-corner-extra-large);
            font-size: var(--md-sys-typescale-body-large-size);
            line-height: var(--md-sys-typescale-body-large-line-height);
            font-family: inherit;
            background: var(--md-sys-color-surface-container-lowest);
            color: var(--md-sys-color-on-surface);
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            box-shadow: var(--md-sys-elevation-level0);
            min-height: 48px;
            box-sizing: border-box;
        }

        .search-input:hover {
            border-color: var(--md-sys-color-on-surface);
            box-shadow: var(--md-sys-elevation-level1);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.12);
            background: var(--md-sys-color-surface);
        }

        .word-search-input {
            border-color: var(--md-sys-color-success);
            background: var(--md-sys-color-success-container);
            color: var(--md-sys-color-on-success-container);
        }

        .word-search-input:hover {
            border-color: var(--md-sys-color-success);
        }

        .word-search-input:focus {
            border-color: var(--md-sys-color-success);
            box-shadow: 0 0 0 2px rgba(56, 161, 105, 0.12);
        }

        .word-match {
            background-color: var(--md-sys-color-warning-container);
            color: var(--md-sys-color-on-warning-container);
            border-radius: var(--md-sys-shape-corner-extra-small);
            padding: 2px 6px;
            font-weight: var(--md-sys-typescale-label-large-weight);
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }

        .search-mode-indicator {
            margin-top: var(--md-sys-spacing-sm);
            padding: var(--md-sys-spacing-sm) var(--md-sys-spacing-md);
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            border-radius: var(--md-sys-shape-corner-small);
            font-size: var(--md-sys-typescale-body-medium-size);
            line-height: var(--md-sys-typescale-body-medium-line-height);
            display: none;
        }



        /* 響應式篩選器容器 */
        .filter-container {
            margin-top: var(--md-sys-spacing-md);
        }

        /* 篩選器內容區域 */
        .filter-content {
            padding: var(--md-sys-spacing-lg);
            background: var(--md-sys-color-surface-container-lowest);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-medium);
            box-shadow: var(--md-sys-elevation-level1);
        }

        .filter-drawer-toggle {
            display: flex;
            align-items: center;
            gap: var(--md-sys-spacing-sm);
            padding: var(--md-sys-spacing-md) var(--md-sys-spacing-lg);
            background: var(--md-sys-color-surface-container-low);
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--md-sys-shape-corner-medium);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            user-select: none;
            font-size: var(--md-sys-typescale-body-large-size);
            color: var(--md-sys-color-on-surface);
            justify-content: center;
        }

        /* 桌面版樣式：直接顯示內容，隱藏切換按鈕 */
        @media (min-width: 600px) {
            .filter-drawer-toggle {
                display: none !important;
            }
            
            .filter-content {
                display: block !important;
                margin-top: 0 !important;
            }
            
            /* 桌面版篩選器容器直接顯示內容，不需要抽屜外觀 */
            .filter-container {
                margin-top: var(--md-sys-spacing-md);
            }
        }

        .filter-drawer-toggle:hover {
            background: var(--md-sys-color-surface-container);
            border-color: var(--md-sys-color-on-surface);
        }

        .filter-drawer-toggle .material-symbols-outlined:first-child {
            font-size: 20px;
            color: var(--md-sys-color-primary);
        }

        .filter-arrow {
            transition: transform 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            font-size: 18px !important;
            color: var(--md-sys-color-on-surface-variant) !important;
        }

        .filter-drawer-toggle[aria-expanded="true"] .filter-arrow {
            transform: rotate(180deg);
        }

        .filter-drawer-content {
            margin-top: var(--md-sys-spacing-sm);
            padding: var(--md-sys-spacing-lg);
            background: var(--md-sys-color-surface-container-lowest);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-medium);
            box-shadow: var(--md-sys-elevation-level1);
        }

        /* 複選篩選器樣式 */
        .multiselect-container {
            position: relative;
            display: inline-block;
            min-width: 180px;
        }

        .multiselect-toggle {
            padding: var(--md-sys-spacing-md) var(--md-sys-spacing-lg);
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--md-sys-shape-corner-medium);
            background: var(--md-sys-color-surface-container-lowest);
            color: var(--md-sys-color-on-surface);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            font-size: var(--md-sys-typescale-body-large-size);
            line-height: var(--md-sys-typescale-body-large-line-height);
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            box-shadow: var(--md-sys-elevation-level0);
            min-height: 48px;
        }

        .multiselect-toggle[disabled] {
            background: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface-variant);
            cursor: not-allowed;
            opacity: 0.38;
        }

        .multiselect-toggle:hover:not([disabled]) {
            border-color: var(--md-sys-color-on-surface);
            box-shadow: var(--md-sys-elevation-level1);
        }

        .multiselect-arrow {
            transition: transform 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            color: var(--md-sys-color-on-surface-variant);
            font-size: 18px;
        }

        .multiselect-dropdown[style*="block"] + .multiselect-toggle .multiselect-arrow,
        .multiselect-toggle[aria-expanded="true"] .multiselect-arrow {
            transform: rotate(180deg);
        }

        .multiselect-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--md-sys-color-surface-container);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-medium);
            max-height: 240px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: var(--md-sys-elevation-level2);
            margin-top: var(--md-sys-spacing-xs);
        }

        .multiselect-option {
            padding: var(--md-sys-spacing-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--md-sys-spacing-md);
            font-size: var(--md-sys-typescale-body-large-size);
            line-height: var(--md-sys-typescale-body-large-line-height);
            color: var(--md-sys-color-on-surface);
            transition: background-color 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        .multiselect-option:hover {
            background: var(--md-sys-color-surface-container-high);
        }

        .multiselect-option:first-child {
            border-radius: var(--md-sys-shape-corner-medium) var(--md-sys-shape-corner-medium) 0 0;
        }

        .multiselect-option:last-child {
            border-radius: 0 0 var(--md-sys-shape-corner-medium) var(--md-sys-shape-corner-medium);
        }

        .multiselect-option input[type="checkbox"] {
            margin: 0;
            width: 18px;
            height: 18px;
            accent-color: var(--md-sys-color-primary);
        }

        /* 結果操作按鈕樣式 */
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .results-actions {
            display: flex;
            gap: var(--md-sys-spacing-sm);
            align-items: center;
        }

        .action-button {
            padding: var(--md-sys-spacing-sm) var(--md-sys-spacing-lg);
            border: none;
            border-radius: var(--md-sys-shape-corner-large);
            cursor: pointer;
            font-size: var(--md-sys-typescale-label-large-size);
            font-weight: var(--md-sys-typescale-label-large-weight);
            font-family: inherit;
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            display: flex;
            align-items: center;
            gap: var(--md-sys-spacing-sm);
            min-height: 40px;
            position: relative;
            overflow: hidden;
        }

        .action-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: currentColor;
            opacity: 0;
            transition: opacity 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        .action-button:hover::before {
            opacity: 0.08;
        }

        .action-button:focus::before {
            opacity: 0.12;
        }

        .action-button:active::before {
            opacity: 0.16;
        }

        .download-dropdown {
            position: relative;
        }

        .download-button {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            box-shadow: none;
        }

        .download-button:hover {
            box-shadow: none;
            filter: brightness(90%);
        }

        .download-button:active {
            box-shadow: none;
            filter: brightness(85%);
        }

        .download-button .material-symbols-outlined {
            font-size: 18px;
        }

        .download-menu {
            position: absolute;
            top: calc(100% + var(--md-sys-spacing-xs));
            right: 0;
            background: var(--md-sys-color-surface-container);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-medium);
            box-shadow: var(--md-sys-elevation-level2);
            z-index: 1000;
            display: none;
            min-width: 180px;
            overflow: hidden;
        }

        .download-option {
            display: flex;
            align-items: center;
            gap: var(--md-sys-spacing-md);
            width: 100%;
            padding: var(--md-sys-spacing-md) var(--md-sys-spacing-lg);
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: var(--md-sys-typescale-body-large-size);
            line-height: var(--md-sys-typescale-body-large-line-height);
            color: var(--md-sys-color-on-surface);
            font-family: inherit;
            transition: background-color 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            position: relative;
            overflow: hidden;
        }

        .download-option .material-symbols-outlined {
            color: var(--md-sys-color-on-surface-variant);
            flex-shrink: 0;
            font-size: 18px;
        }

        .download-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: currentColor;
            opacity: 0;
            transition: opacity 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        .download-option:hover::before {
            opacity: 0.08;
        }

        .download-option:focus::before {
            opacity: 0.12;
        }

        .download-option:active::before {
            opacity: 0.16;
        }

        /* 禁用狀態樣式 */
        input:disabled {
            background: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface-variant);
            cursor: not-allowed;
            opacity: 0.38;
        }

        .filter-section {
            display: flex;
            gap: var(--md-sys-spacing-lg);
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: var(--md-sys-spacing-md);
        }

        .filter-label {
            font-weight: var(--md-sys-typescale-title-medium-weight);
            font-size: var(--md-sys-typescale-title-medium-size);
            line-height: var(--md-sys-typescale-title-medium-line-height);
            color: var(--md-sys-color-on-surface);
            white-space: nowrap;
        }

        .filter-select {
            padding: var(--md-sys-spacing-md);
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--md-sys-shape-corner-medium);
            background: var(--md-sys-color-surface-container-lowest);
            color: var(--md-sys-color-on-surface);
            font-size: var(--md-sys-typescale-body-large-size);
            font-family: inherit;
            min-width: 140px;
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        .filter-select:hover {
            border-color: var(--md-sys-color-on-surface);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.12);
        }

        .status-section {
            margin-top: var(--md-sys-spacing-lg);
            padding: 0;
            background: transparent;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .status-text {
            color: var(--md-sys-color-on-primary-container);
            font-weight: var(--md-sys-typescale-body-medium-weight);
            font-size: var(--md-sys-typescale-body-small-size);
            line-height: var(--md-sys-typescale-body-small-line-height);
            opacity: 0.8;
            margin-bottom: var(--md-sys-spacing-xs);
        }

        .cache-status {
            margin-top: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--md-sys-spacing-md);
            padding: 0;
            background: transparent;
        }

        .cache-indicator {
            font-size: var(--md-sys-typescale-body-small-size);
            line-height: var(--md-sys-typescale-body-small-line-height);
            color: var(--md-sys-color-on-primary-container);
            opacity: 0.7;
        }

        .cache-indicator.using-cache {
            color: var(--md-sys-color-success);
            opacity: 0.8;
        }

        .cache-indicator.old-cache {
            color: var(--md-sys-color-warning);
            opacity: 0.8;
        }

        .refresh-button {
            padding: var(--md-sys-spacing-xs) var(--md-sys-spacing-sm);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--md-sys-shape-corner-medium);
            background: rgba(255, 255, 255, 0.1);
            color: var(--md-sys-color-on-primary-container);
            cursor: pointer;
            font-size: var(--md-sys-typescale-body-small-size);
            font-weight: var(--md-sys-typescale-body-small-weight);
            font-family: inherit;
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--md-sys-spacing-xs);
            min-height: 28px;
            opacity: 0.7;
        }

        .refresh-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: currentColor;
            opacity: 0;
            transition: opacity 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        .refresh-button:hover {
            opacity: 1;
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.2);
        }

        .refresh-button:hover::before {
            opacity: 0.08;
        }

        .refresh-button:focus::before {
            opacity: 0.12;
        }

        .refresh-button:active::before {
            opacity: 0.16;
        }

        .refresh-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .refresh-button:disabled::before {
            display: none;
        }

        .refresh-button .material-symbols-outlined {
            font-size: 16px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: var(--md-sys-spacing-xl);
        }

        .spinner {
            border: 4px solid var(--md-sys-color-surface-variant);
            border-top: 4px solid var(--md-sys-color-primary);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--md-sys-spacing-lg);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .content {
            padding: var(--md-sys-spacing-xl);
            margin-top: 0;
            background: var(--md-sys-color-surface);
            border-radius: 0 0 var(--md-sys-shape-corner-extra-large) var(--md-sys-shape-corner-extra-large);
        }

        /* 確保結果區域有足夠的空間，不會被固定控制區域擋住 */
        .results-container {
            margin-top: var(--md-sys-spacing-lg);
        }

        /* 平滑滾動效果 */
        html {
            scroll-behavior: smooth;
        }

        .results-info {
            margin-top: var(--md-sys-spacing-lg);
            padding: var(--md-sys-spacing-md) var(--md-sys-spacing-lg);
            background: var(--md-sys-color-success-container);
            color: var(--md-sys-color-on-success-container);
            border-radius: var(--md-sys-shape-corner-medium);
            border-left: 4px solid var(--md-sys-color-success);
        }

        .results-count {
            font-weight: var(--md-sys-typescale-title-medium-weight);
            font-size: var(--md-sys-typescale-title-medium-size);
            line-height: var(--md-sys-typescale-title-medium-line-height);
            color: var(--md-sys-color-on-success-container);
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--md-sys-color-surface-container-lowest);
            border-radius: var(--md-sys-shape-corner-large);
            overflow: hidden;
            box-shadow: none;
            border: 1px solid var(--md-sys-color-outline);
            table-layout: fixed;
        }

        .results-table th:nth-child(1), 
        .results-table td:nth-child(1) {
            width: 8%;
            min-width: 60px;
        }

        .results-table th:nth-child(2), 
        .results-table td:nth-child(2) {
            width: 15%;
            min-width: 120px;
        }

        .results-table th:nth-child(3), 
        .results-table td:nth-child(3) {
            width: 17%;
            min-width: 140px;
        }

        .results-table th:nth-child(4), 
        .results-table td:nth-child(4) {
            width: 35%;
        }

        .results-table th:nth-child(5), 
        .results-table td:nth-child(5) {
            width: 25%;
        }

        .results-table th {
            background: var(--md-sys-color-surface-container-low);
            color: var(--md-sys-color-on-surface-variant);
            padding: var(--md-sys-spacing-lg);
            text-align: left;
            font-weight: var(--md-sys-typescale-title-medium-weight);
            font-size: var(--md-sys-typescale-body-medium-size);
            line-height: var(--md-sys-typescale-title-medium-line-height);
            border-bottom: 1px solid var(--md-sys-color-outline);
        }

        .results-table td {
            padding: var(--md-sys-spacing-lg);
            border-bottom: 1px solid var(--md-sys-color-outline);
            vertical-align: top;
            color: var(--md-sys-color-on-surface);
        }

        .results-table tbody tr:last-child td {
            border-bottom: none;
        }

        .results-table tr:hover {
            background: var(--md-sys-color-primary-container);
        }

        .sentence-cell {
            max-width: 500px;
            line-height: var(--md-sys-typescale-body-large-line-height);
            position: relative;
        }

        .sentence-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: var(--md-sys-spacing-md);
        }

        .sentence-text {
            flex: 1;
            font-size: var(--md-sys-typescale-body-large-size);
            line-height: var(--md-sys-typescale-body-large-line-height);
        }

        .copy-sentence-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--md-sys-color-on-surface-variant);
            padding: 0;
            border-radius: 50%;
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        .copy-sentence-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: currentColor;
            opacity: 0;
            border-radius: inherit;
            transition: opacity 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        .copy-sentence-btn:hover {
            color: var(--md-sys-color-on-surface);
        }

        .copy-sentence-btn:hover::before {
            opacity: 0.08;
        }

        .copy-sentence-btn:focus::before {
            opacity: 0.12;
        }

        .copy-sentence-btn:active::before {
            opacity: 0.16;
        }

        .copy-sentence-btn.copied {
            color: var(--md-sys-color-success);
        }

        .copy-sentence-btn .material-symbols-outlined {
            font-size: 18px;
        }

        .translation-cell {
            max-width: 500px;
            line-height: var(--md-sys-typescale-body-large-line-height);
            color: var(--md-sys-color-on-surface-variant);
            font-size: var(--md-sys-typescale-body-large-size);
        }

        .year-badge {
            background: var(--md-sys-color-tertiary-container);
            color: var(--md-sys-color-on-tertiary-container);
            padding: var(--md-sys-spacing-xs) var(--md-sys-spacing-sm);
            border-radius: var(--md-sys-shape-corner-small);
            font-size: var(--md-sys-typescale-body-small-size);
            font-weight: var(--md-sys-typescale-label-large-weight);
            line-height: var(--md-sys-typescale-label-large-line-height);
            font-family: inherit;
        }

        .part-badge {
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            padding: var(--md-sys-spacing-xs) var(--md-sys-spacing-sm);
            border-radius: var(--md-sys-shape-corner-small);
            font-size: var(--md-sys-typescale-body-small-size);
            font-weight: var(--md-sys-typescale-label-large-weight);
            line-height: var(--md-sys-typescale-label-large-line-height);
            font-family: inherit;
            white-space: nowrap;
            display: inline-block;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: help;
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        .part-badge:hover {
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            transform: scale(1.02);
            filter: brightness(95%);
        }

        .no-results {
            text-align: center;
            padding: var(--md-sys-spacing-xxl);
            color: var(--md-sys-color-on-surface-variant);
            font-size: var(--md-sys-typescale-title-large-size);
            line-height: var(--md-sys-typescale-title-large-line-height);
        }

        .error-message {
            background: var(--md-sys-color-error-container);
            color: var(--md-sys-color-on-error-container);
            padding: var(--md-sys-spacing-lg);
            border-radius: var(--md-sys-shape-corner-medium);
            border-left: 4px solid var(--md-sys-color-error);
            margin-bottom: var(--md-sys-spacing-lg);
            font-size: var(--md-sys-typescale-body-large-size);
            line-height: var(--md-sys-typescale-body-large-line-height);
        }

        /* Mobile-first responsive design */
        @media (max-width: 599px) {
            body {
                padding: var(--md-sys-spacing-sm);
            }

            /* 手機版隱藏搜尋狀態說明 */
            .search-mode-indicator {
                display: none !important;
            }

            /* 手機版篩選器內容預設隱藏 */
            .filter-content {
                display: none;
            }

            .header {
                padding: var(--md-sys-spacing-lg) var(--md-sys-spacing-md);
            }

            .header h1 {
                font-size: var(--md-sys-typescale-title-large-size);
                line-height: var(--md-sys-typescale-title-large-line-height);
            }

            .controls {
                padding: var(--md-sys-spacing-lg) var(--md-sys-spacing-md);
            }

            .controls.scrolled {
                padding: var(--md-sys-spacing-md);
            }
            
            .search-section {
                flex-direction: column;
                gap: var(--md-sys-spacing-md);
            }
            
            .search-box {
                min-width: auto;
            }
            
            .filter-section {
                flex-direction: column;
                align-items: stretch;
                gap: var(--md-sys-spacing-md);
            }

            .filter-group {
                flex-direction: column;
                align-items: stretch;
                gap: var(--md-sys-spacing-sm);
            }

            .filter-drawer-content .filter-section {
                flex-direction: column;
                gap: var(--md-sys-spacing-lg);
            }

            .multiselect-container {
                min-width: auto;
                width: 100%;
            }

            .content {
                padding: var(--md-sys-spacing-md);
                min-height: calc(100vh - 180px);
            }
            
            .results-table {
                font-size: var(--md-sys-typescale-body-medium-size);
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            /* 手機版隱藏部分欄位 */
            .results-table th:nth-child(3), /* 來源 */
            .results-table td:nth-child(3),
            .results-table th:nth-child(5), /* 例句翻譯 */
            .results-table td:nth-child(5) {
                display: none;
            }
            
            .results-table th,
            .results-table td {
                padding: var(--md-sys-spacing-md);
            }

            .results-table th:nth-child(1), 
            .results-table td:nth-child(1) {
                min-width: 50px;
                width: 10%;
            }

            .results-table th:nth-child(2), 
            .results-table td:nth-child(2) {
                min-width: 100px;
                width: 20%;
            }

            .results-table th:nth-child(3), 
            .results-table td:nth-child(3) {
                min-width: 120px;
                width: 25%;
            }

            .sentence-cell,
            .translation-cell {
                max-width: 280px;
                white-space: normal;
            }

            .results-header {
                flex-direction: column;
                gap: var(--md-sys-spacing-md);
                align-items: stretch;
            }

            .results-actions {
                flex-direction: column;
                gap: var(--md-sys-spacing-sm);
                align-items: stretch;
            }

            .action-button {
                justify-content: center;
            }

            .cache-status {
                flex-direction: column;
                gap: var(--md-sys-spacing-sm);
                align-items: stretch;
            }

            .refresh-button {
                align-self: center;
                min-width: 140px;
            }



            .download-menu {
                position: fixed;
                top: auto;
                bottom: var(--md-sys-spacing-md);
                left: var(--md-sys-spacing-md);
                right: var(--md-sys-spacing-md);
                min-width: auto;
            }
        }

        /* Tablet responsive design */
        @media (min-width: 600px) and (max-width: 1023px) {
            .container {
                margin: 0 var(--md-sys-spacing-md);
            }

            .sentence-cell,
            .translation-cell {
                max-width: 350px;
            }

            .results-table th,
            .results-table td {
                padding: var(--md-sys-spacing-lg) var(--md-sys-spacing-md);
            }
        }

        /* Desktop enhancements */

        @media (min-width: 1024px) {
            .sentence-cell,
            .translation-cell {
                max-width: 600px;
            }

            .results-table th,
            .results-table td {
                padding: var(--md-sys-spacing-lg);
            }
        }

        .site-footer {
            text-align: center;
            padding: var(--md-sys-spacing-lg);
            color: var(--md-sys-color-on-surface-variant);
            font-size: var(--md-sys-typescale-body-medium-size);
        }

        /* ========================================
           緊湊檢視模式 - Compact View Mode
           ======================================== */
        
        /* 緊湊模式切換按鈕 */
        .compact-toggle {
            position: fixed;
            top: 20px;
            right: 24px;
            z-index: 1000;
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            border-radius: var(--md-sys-shape-corner-full);
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--md-sys-elevation-level3);
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            font-size: 20px;
        }

        .compact-toggle:hover {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            transform: scale(1.05);
        }

        /* 緊湊模式主體樣式 */
        body.compact-mode .header {
            padding: var(--md-sys-compact-spacing-lg) var(--md-sys-compact-spacing-xl);
        }

        body.compact-mode .header h1 {
            font-size: var(--md-sys-typescale-title-large-size);
            line-height: var(--md-sys-typescale-title-large-line-height);
            margin-bottom: var(--md-sys-compact-spacing-xs);
        }

        body.compact-mode .header p {
            font-size: var(--md-sys-typescale-body-medium-size);
            line-height: var(--md-sys-typescale-body-medium-line-height);
            margin-bottom: var(--md-sys-compact-spacing-sm);
        }

        body.compact-mode .controls {
            padding: var(--md-sys-compact-spacing-lg);
        }

        body.compact-mode .search-section {
            gap: var(--md-sys-compact-spacing-sm);
            margin-bottom: var(--md-sys-compact-spacing-md);
        }

        body.compact-mode .search-input {
            padding: var(--md-sys-compact-spacing-sm) var(--md-sys-compact-spacing-md);
            font-size: var(--md-sys-typescale-body-medium-size);
            min-height: 36px;
        }

        body.compact-mode .search-mode-indicator {
            margin-top: var(--md-sys-compact-spacing-xs);
            padding: var(--md-sys-compact-spacing-xs) var(--md-sys-compact-spacing-sm);
            font-size: var(--md-sys-typescale-body-small-size);
        }

        body.compact-mode .filter-container {
            margin-top: var(--md-sys-compact-spacing-sm);
        }

        body.compact-mode .filter-drawer-toggle {
            gap: var(--md-sys-compact-spacing-xs);
            padding: var(--md-sys-compact-spacing-sm) var(--md-sys-compact-spacing-md);
        }

        body.compact-mode .filter-section {
            padding: var(--md-sys-compact-spacing-md);
        }

        body.compact-mode .filter-group {
            gap: var(--md-sys-compact-spacing-sm);
        }

        body.compact-mode .multiselect-toggle {
            padding: var(--md-sys-compact-spacing-sm) var(--md-sys-compact-spacing-md);
            min-height: 32px;
        }

        body.compact-mode .multiselect-option {
            padding: var(--md-sys-compact-spacing-sm);
            font-size: var(--md-sys-typescale-body-small-size);
        }

        body.compact-mode .results-info {
            margin-top: var(--md-sys-compact-spacing-md);
            padding: var(--md-sys-compact-spacing-sm) var(--md-sys-compact-spacing-md);
        }

        body.compact-mode .results-header {
            gap: var(--md-sys-compact-spacing-md);
        }

        body.compact-mode .action-button {
            gap: var(--md-sys-compact-spacing-xs);
            padding: var(--md-sys-compact-spacing-xs) var(--md-sys-compact-spacing-md);
            min-height: 32px;
            font-size: var(--md-sys-typescale-body-small-size);
        }

        body.compact-mode .download-option {
            gap: var(--md-sys-compact-spacing-sm);
            padding: var(--md-sys-compact-spacing-sm) var(--md-sys-compact-spacing-md);
            font-size: var(--md-sys-typescale-body-small-size);
        }

        body.compact-mode .results-table th {
            padding: var(--md-sys-compact-spacing-md);
            font-size: var(--md-sys-typescale-body-small-size);
        }

        body.compact-mode .results-table td {
            padding: var(--md-sys-compact-spacing-md);
            font-size: var(--md-sys-typescale-body-small-size);
            line-height: var(--md-sys-typescale-body-small-line-height);
        }

        body.compact-mode .sentence-content {
            gap: var(--md-sys-compact-spacing-sm);
        }

        body.compact-mode .copy-sentence-btn {
            padding: var(--md-sys-compact-spacing-xs);
            width: 24px;
            height: 24px;
            font-size: 16px;
        }

        body.compact-mode .status-section {
            margin-top: var(--md-sys-compact-spacing-sm);
        }

        body.compact-mode .status-text {
            margin-bottom: var(--md-sys-compact-spacing-xs);
            font-size: var(--md-sys-typescale-body-small-size);
        }

        body.compact-mode .cache-status {
            gap: var(--md-sys-compact-spacing-sm);
        }

        body.compact-mode .refresh-button {
            gap: var(--md-sys-compact-spacing-xs);
            padding: var(--md-sys-compact-spacing-xs) var(--md-sys-compact-spacing-sm);
            min-height: 24px;
            font-size: var(--md-sys-typescale-body-small-size);
        }

        /* 緊湊模式響應式調整 */
        @media (max-width: 599px) {
            body.compact-mode .header {
                padding: var(--md-sys-compact-spacing-md);
            }
            
            body.compact-mode .controls {
                padding: var(--md-sys-compact-spacing-sm);
            }
            
            body.compact-mode .search-input {
                padding: var(--md-sys-compact-spacing-xs) var(--md-sys-compact-spacing-sm);
                min-height: 32px;
            }
            
            body.compact-mode .results-table th,
            body.compact-mode .results-table td {
                padding: var(--md-sys-compact-spacing-sm);
            }
        }
    </style>
</head>
<body>
    <!-- 緊湊模式切換按鈕 -->
    <button class="compact-toggle" id="compactToggle" title="切換緊湊檢視模式">
        <span class="material-symbols-outlined">compress</span>
    </button>

    <div class="container">
        <div class="header">
            <h1>VocabGem <span style="font-size: 0.7em; color: var(--md-sys-color-on-surface-variant);">詞彙寶石</span></h1>
            <p>挖掘學測英文考題中的詞彙寶藏 - 每個例句都是珍貴的學習資源</p>
            
            <div class="status-section">
                <div class="status-text" id="statusText">準備載入資料...</div>
                <div class="cache-status" id="cacheStatus" style="display: none;">
                    <span id="cacheIndicator"></span>
                    <button id="refreshButton" class="refresh-button" title="重新載入最新資料">
                        <span class="material-symbols-outlined">refresh</span>
                        重新載入
                    </button>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="search-section">
                <div class="search-box">
                    <input type="text" id="wordSearchInput" class="search-input word-search-input" placeholder="輸入單字，在 VocabGem 中挖掘珍貴的例句寶石 💎" disabled>
                </div>
            </div>

            <!-- 搜尋狀態指示器移到搜尋框下方 -->
            <div class="search-mode-indicator" id="searchModeIndicator"></div>

            <!-- 響應式篩選器容器 -->
            <div class="filter-container" id="filterContainer" style="display: none;">
                <!-- 手機版抽屜切換按鈕 -->
                <div class="filter-drawer-toggle" id="filterDrawerToggle">
                    <span class="material-symbols-outlined">tune</span>
                    <span>進階篩選</span>
                    <span class="material-symbols-outlined filter-arrow">expand_more</span>
                </div>
                
                <!-- 篩選器內容區域 -->
                <div class="filter-content" id="filterContent">
                    <div class="filter-section">
                        <div class="filter-group">
                            <label class="filter-label">年份：</label>
                            <div class="multiselect-container" id="yearFilterContainer">
                                <div class="multiselect-toggle" id="yearFilterToggle" disabled>
                                    <span>選擇年份</span>
                                    <span class="multiselect-arrow material-symbols-outlined">expand_more</span>
                                </div>
                                <div class="multiselect-dropdown" id="yearFilterDropdown">
                                </div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">題型：</label>
                            <div class="multiselect-container" id="partFilterContainer">
                                <div class="multiselect-toggle" id="partFilterToggle" disabled>
                                    <span>選擇題型</span>
                                    <span class="multiselect-arrow material-symbols-outlined">expand_more</span>
                                </div>
                                <div class="multiselect-dropdown" id="partFilterDropdown">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>正在載入資料中...</div>
            </div>

            <div id="resultsInfo" class="results-info" style="display: none;">
                <div class="results-header">
                    <span class="results-count" id="resultsCount"></span>
                    <div class="results-actions">
                        <div class="download-dropdown">
                            <button id="downloadButton" class="action-button download-button" title="下載結果">
                                <span class="material-symbols-outlined">download</span>
                                下載
                                <span class="material-symbols-outlined">expand_more</span>
                            </button>
                            <div class="download-menu" id="downloadMenu">
                                <button onclick="downloadData('markdown')" class="download-option">
                                    <span class="material-symbols-outlined">description</span>
                                    Markdown (.md)
                                </button>
                                <button onclick="downloadData('tsv')" class="download-option">
                                    <span class="material-symbols-outlined">table_view</span>
                                    TSV (.tsv)
                                </button>
                                <button onclick="downloadData('excel')" class="download-option">
                                    <span class="material-symbols-outlined">table_chart</span>
                                    Excel (.xlsx)
                                </button>
                                <button onclick="downloadData('word')" class="download-option">
                                    <span class="material-symbols-outlined">description</span>
                                    Word (.docx)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content">
             <div id="errorMessage" class="error-message" style="display: none;"></div>
            
            <div id="resultsContainer" class="results-container">
                <table id="resultsTable" class="results-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>年份</th>
                            <th>題型</th>
                            <th>來源</th>
                            <th>例句 (English)</th>
                            <th>例句翻譯 (中文)</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                    </tbody>
                </table>
            </div>

            <div id="noResults" class="no-results" style="display: none;">
                沒有找到符合條件的結果
            </div>
        </div>
    </div>

    <script>
        // Google Apps Script 部署 URL（請填入您的部署 URL）
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx1WGutPq5TBle1TXEdGSpD84u9w97C36pmH_G6HxofF9SAgMW72I24UFR2nNubK6v3Lw/exec'; // 請將此替換為您的 Google Apps Script 部署 URL
 
        // 全域變數
        let allData = [];
        let filteredData = [];
        let years = new Set();
        let parts = new Set();
        let wordSearchResults = []; // 儲存單字搜尋的結果
        
        // 快取相關常數
        const CACHE_KEY = 'vocabSentenceFinder_data';
        const CACHE_TIMESTAMP_KEY = 'vocabSentenceFinder_lastVisit';
        const CACHE_EXPIRY_HOURS = 24; // 24小時快取有效期
 
        // DOM 元素
        const wordSearchInput = document.getElementById('wordSearchInput');
        const searchModeIndicator = document.getElementById('searchModeIndicator');
        const yearFilterToggle = document.getElementById('yearFilterToggle');
        const yearFilterDropdown = document.getElementById('yearFilterDropdown');
        const partFilterToggle = document.getElementById('partFilterToggle');
        const partFilterDropdown = document.getElementById('partFilterDropdown');
        const statusText = document.getElementById('statusText');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('errorMessage');
        const resultsInfo = document.getElementById('resultsInfo');
        const resultsCount = document.getElementById('resultsCount');
        const resultsTable = document.getElementById('resultsTable');
        const resultsBody = document.getElementById('resultsBody');
        const noResults = document.getElementById('noResults');

        const downloadButton = document.getElementById('downloadButton');
        const downloadMenu = document.getElementById('downloadMenu');
        const filterSection = document.querySelector('.filter-section');
        const cacheStatus = document.getElementById('cacheStatus');
        const cacheIndicator = document.getElementById('cacheIndicator');
        const refreshButton = document.getElementById('refreshButton');
        
        // 篩選器元素
        const filterContainer = document.getElementById('filterContainer');
        const filterDrawerToggle = document.getElementById('filterDrawerToggle');
        const filterContent = document.getElementById('filterContent');
        
        // 緊湊模式元素
        const compactToggle = document.getElementById('compactToggle');

        // 全域狀態
        let isDataLoaded = false;
        let selectedYears = new Set();
        let selectedParts = new Set();
        let isUpdatingFilters = false; // 防止無限循環的標誌
 
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
 
        function initializeApp() {
            // 設定事件監聽器
            wordSearchInput.addEventListener('input', debounce(handleWordSearch, 300));
            
            // 複選篩選器事件
            yearFilterToggle.addEventListener('click', () => toggleMultiselect('year'));
            partFilterToggle.addEventListener('click', () => toggleMultiselect('part'));
            
            // 篩選器抽屜事件
            filterDrawerToggle.addEventListener('click', () => toggleFilterDrawer());
            
            // 下載功能
            downloadButton.addEventListener('click', () => toggleDownloadMenu());
            
            // 緊湊模式切換功能
            compactToggle.addEventListener('click', () => toggleCompactMode());
            
            // 重新載入功能
            refreshButton.addEventListener('click', () => {
                refreshButton.disabled = true;
                loadData(true).finally(() => {
                    refreshButton.disabled = false;
                });
            });
            
            // 點擊外部關閉下拉選單
            document.addEventListener('click', (e) => {
                // 篩選器下拉選單
                if (!yearFilterToggle.contains(e.target) && !yearFilterDropdown.contains(e.target)) {
                    yearFilterDropdown.style.display = 'none';
                    yearFilterToggle.setAttribute('aria-expanded', false);
                }
                if (!partFilterToggle.contains(e.target) && !partFilterDropdown.contains(e.target)) {
                    partFilterDropdown.style.display = 'none';
                    partFilterToggle.setAttribute('aria-expanded', false);
                }
                
                // 下載選單
                if (!downloadButton.contains(e.target) && !downloadMenu.contains(e.target)) {
                    downloadMenu.style.display = 'none';
                }
            });

            // 監聽滾動事件來處理 sticky 控制區域的視覺效果
            setupStickyControls();
            
            // 初始化緊湊模式偏好設定
            initializeCompactMode();
            
            // 監聽視窗大小變化，確保篩選器顯示正確
            window.addEventListener('resize', () => {
                if (filterContainer.style.display === 'block') {
                    if (window.innerWidth >= 600) {
                        // 桌面版：確保內容顯示
                        filterContent.style.display = 'block';
                    } else {
                        // 手機版：恢復抽屜狀態（如果之前是展開的話保持展開）
                        // CSS 會自動處理隱藏
                    }
                }
            });
            
            // 載入資料
            loadData();
        }

        function setupStickyControls() {
            const controls = document.querySelector('.controls');
            let isScrolled = false;

            window.addEventListener('scroll', () => {
                const currentScroll = window.pageYOffset;
                
                if (currentScroll > 100 && !isScrolled) {
                    controls.classList.add('scrolled');
                    isScrolled = true;
                } else if (currentScroll <= 100 && isScrolled) {
                    controls.classList.remove('scrolled');
                    isScrolled = false;
                }
            });
        }
 
        // 快取管理函數
        function isCacheValid() {
            const lastVisit = localStorage.getItem(CACHE_TIMESTAMP_KEY);
            if (!lastVisit) return false;
            
            const lastVisitTime = new Date(lastVisit);
            const now = new Date();
            const hoursDiff = (now - lastVisitTime) / (1000 * 60 * 60);
            
            return hoursDiff < CACHE_EXPIRY_HOURS;
        }

        function getCachedData() {
            try {
                const cachedData = localStorage.getItem(CACHE_KEY);
                return cachedData ? JSON.parse(cachedData) : null;
            } catch (error) {
                console.warn('讀取快取資料失敗:', error);
                return null;
            }
        }

        function setCachedData(data) {
            try {
                localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                localStorage.setItem(CACHE_TIMESTAMP_KEY, new Date().toISOString());
                return true;
            } catch (error) {
                console.warn('儲存快取資料失敗:', error);
                return false;
            }
        }

        function clearCache() {
            localStorage.removeItem(CACHE_KEY);
            localStorage.removeItem(CACHE_TIMESTAMP_KEY);
        }

        function showCacheStatus(isUsingCache, isOldCache = false) {
            if (isUsingCache) {
                cacheStatus.style.display = 'flex';
                const lastVisit = localStorage.getItem(CACHE_TIMESTAMP_KEY);
                const lastVisitTime = lastVisit ? new Date(lastVisit) : new Date();
                const timeAgo = formatTimeAgo(lastVisitTime);
                
                if (isOldCache) {
                    cacheIndicator.textContent = `⚠️ 使用舊快取資料 (${timeAgo})`;
                    cacheIndicator.className = 'cache-indicator old-cache';
                } else {
                    cacheIndicator.textContent = `💾 使用快取資料 (${timeAgo})`;
                    cacheIndicator.className = 'cache-indicator using-cache';
                }
            } else {
                cacheStatus.style.display = 'none';
            }
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            
            if (diffHours >= 24) {
                const diffDays = Math.floor(diffHours / 24);
                return `${diffDays} 天前`;
            } else if (diffHours >= 1) {
                return `${diffHours} 小時前`;
            } else if (diffMinutes >= 1) {
                return `${diffMinutes} 分鐘前`;
            } else {
                return '剛剛';
            }
        }
 
        async function loadData(forceRefresh = false) {
            try {
                showLoading(true);
                
                // 檢查是否可以使用快取
                if (!forceRefresh && isCacheValid()) {
                    const cachedData = getCachedData();
                    if (cachedData && cachedData.length > 0) {
                        updateStatus('正在載入快取資料...');
                        allData = cachedData;
                        
                        updateStatus(`使用快取資料載入 ${allData.length} 筆資料！系統已準備就緒。`);
                        showLoading(false);
                        
                        // 啟用所有功能
                        enableAllFeatures();
                        isDataLoaded = true;
                        
                        // 顯示快取狀態
                        showCacheStatus(true);
                        return;
                    }
                }
                
                // 載入新資料
                updateStatus('正在從 Google Sheets 載入最新資料...');
                showCacheStatus(false);
 
                // 嘗試使用 GET 請求
                let response;
                try {
                    response = await fetch(`${APPS_SCRIPT_URL}?action=getData`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                } catch (fetchError) {
                    console.log('GET 請求失敗，嘗試 POST 請求...');
                    // 如果 GET 失敗，嘗試 POST
                    response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: 'action=getData'
                    });
                }
 
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                }
 
                const result = await response.json();
                console.log('API 回應:', result);
                
                if (!result.success) {
                    throw new Error(result.error || result.message || '載入資料失敗');
                }
 
                // 處理資料
                allData = processSheetData(result.data);
                
                // 儲存到快取
                setCachedData(allData);
                
                updateStatus(`成功載入 ${allData.length} 筆最新資料！系統已準備就緒。`);
                showLoading(false);
                 
                // 啟用所有功能
                enableAllFeatures();
                isDataLoaded = true;
 
            } catch (error) {
                console.error('載入資料時發生錯誤:', error);
                
                // 如果網路載入失敗，嘗試使用舊快取
                const cachedData = getCachedData();
                if (cachedData && cachedData.length > 0) {
                    console.log('使用舊快取資料作為備用');
                    allData = cachedData;
                    updateStatus(`網路載入失敗，使用舊快取資料 (${allData.length} 筆)。系統已準備就緒。`);
                    showLoading(false);
                    enableAllFeatures();
                    isDataLoaded = true;
                    showCacheStatus(true, true);
                } else {
                showError('載入資料時發生錯誤: ' + error.message);
                showLoading(false);
                }
            }
        }
 
        function processSheetData(sheetData) {
            return sheetData.map(row => {
                return {
                    year: String(row['Year_code'] || row['year'] || ''), // 確保年份是字串
                    part: String(row['Part'] || row['part'] || ''), // 確保題型是字串
                    source: String(row['Source_code'] || row['source'] || ''),
                    sentence: String(row['Sentence'] || row['sentence'] || ''),
                    translation: String(row['Translation Traditional Chinese'] || row['translation'] || '')
                };
            }).filter(item => item.sentence && item.translation); // 過濾空資料
        }
 
        // 啟用所有功能
        function enableAllFeatures() {
            wordSearchInput.disabled = false;
        }

        // 切換篩選器抽屜（只在手機版有效）
        function toggleFilterDrawer() {
            // 只在手機版（小於 600px）才執行抽屜切換
            if (window.innerWidth >= 600) {
                return; // 桌面版不執行抽屜功能
            }
            
            const isOpen = filterContent.style.display === 'block';
            filterContent.style.display = isOpen ? 'none' : 'block';
            filterDrawerToggle.setAttribute('aria-expanded', !isOpen);
        }

        // 切換複選下拉選單
        function toggleMultiselect(type) {
            if (!isDataLoaded) return;
            
            if (type === 'year') {
                const isVisible = yearFilterDropdown.style.display === 'block';
                yearFilterDropdown.style.display = isVisible ? 'none' : 'block';
                yearFilterToggle.setAttribute('aria-expanded', !isVisible);
                partFilterDropdown.style.display = 'none';
                partFilterToggle.setAttribute('aria-expanded', false);
            } else if (type === 'part') {
                const isVisible = partFilterDropdown.style.display === 'block';
                partFilterDropdown.style.display = isVisible ? 'none' : 'block';
                partFilterToggle.setAttribute('aria-expanded', !isVisible);
                yearFilterDropdown.style.display = 'none';
                yearFilterToggle.setAttribute('aria-expanded', false);
            }
        }

        // 更新複選狀態
        function updateMultiselect(type) {
            if (type === 'year') {
                selectedYears.clear();
                const checkboxes = yearFilterDropdown.querySelectorAll('input[type="checkbox"]:checked');
                checkboxes.forEach(cb => selectedYears.add(cb.value));
                
                // 更新年份篩選器的顯示文字
                const totalYears = yearFilterDropdown.querySelectorAll('input[type="checkbox"]').length;
                updateFilterToggleText('year', totalYears);
                
                // 當年份篩選器改變時，動態更新題型篩選器的可用選項（避免無限循環）
                if (!isUpdatingFilters) {
                    updateDependentFilter('part');
                }
            } else if (type === 'part') {
                selectedParts.clear();
                const checkboxes = partFilterDropdown.querySelectorAll('input[type="checkbox"]:checked');
                checkboxes.forEach(cb => selectedParts.add(cb.value));
                
                // 更新題型篩選器的顯示文字
                const totalParts = partFilterDropdown.querySelectorAll('input[type="checkbox"]').length;
                updateFilterToggleText('part', totalParts);
                
                // 當題型篩選器改變時，動態更新年份篩選器的可用選項（避免無限循環）
                if (!isUpdatingFilters) {
                    updateDependentFilter('year');
                }
            }
            
            // 重新執行篩選
            applyFilters();
        }
        


        // 更新篩選器按鈕的顯示文字
        function updateFilterToggleText(type, total) {
            if (type === 'year') {
                const selectedCount = selectedYears.size;
                yearFilterToggle.querySelector('span').textContent = 
                    selectedCount === 0 ? '選擇年份' : 
                    selectedCount === total ? '全部年份' : 
                    `已選 ${selectedCount} 個年份`;
            } else if (type === 'part') {
                const selectedCount = selectedParts.size;
                partFilterToggle.querySelector('span').textContent = 
                    selectedCount === 0 ? '選擇題型' : 
                    selectedCount === total ? '全部題型' : 
                    `已選 ${selectedCount} 個題型`;
            }
        }
        
        // 應用篩選器
        function applyFilters() {
            if (wordSearchResults.length === 0) {
                filteredData = [];
                displayDataWithHighlight([], []);
                return;
            }
            
            filteredData = wordSearchResults.filter(item => {
                // 年份篩選（複選）- 確保資料類型一致
                const itemYear = String(item.year);
                const matchesYear = selectedYears.size === 0 || selectedYears.has(itemYear);

                // 題型篩選（複選）- 確保資料類型一致
                const itemPart = String(item.part);
                const matchesPart = selectedParts.size === 0 || selectedParts.has(itemPart);

                return matchesYear && matchesPart;
            });

            // 如果有搜尋詞，則高亮顯示
            const wordTerm = wordSearchInput.value.trim();
            if (wordTerm) {
                const variations = generateWordVariations(wordTerm);
                displayDataWithHighlight(filteredData, variations);
            } else {
                displayData(filteredData);
            }
        }

        // 計算在當前篩選條件下可用的選項
        function getAvailableOptions(type, baseData = wordSearchResults) {
            if (baseData.length === 0) return [];
            
            let filteredData = baseData;
            
            // 根據另一個篩選器的選擇來過濾資料
            if (type === 'year') {
                // 計算年份選項時，考慮已選擇的題型
                if (selectedParts.size > 0) {
                    filteredData = baseData.filter(item => {
                        const itemPart = String(item.part);
                        return selectedParts.has(itemPart);
                    });
                }
                return Array.from(new Set(filteredData.map(item => item.year))).sort();
            } else if (type === 'part') {
                // 計算題型選項時，考慮已選擇的年份
                if (selectedYears.size > 0) {
                    filteredData = baseData.filter(item => {
                        const itemYear = String(item.year);
                        return selectedYears.has(itemYear);
                    });
                }
                return Array.from(new Set(filteredData.map(item => item.part))).sort();
            }
            
            return [];
        }
        
        // 更新依賴的篩選器（雙向動態更新的核心功能）
        function updateDependentFilter(type) {
            if (!isDataLoaded || wordSearchResults.length === 0) return;
            
            const availableOptions = getAvailableOptions(type);
            
            if (type === 'year') {
                updateFilterDropdown('year', availableOptions, selectedYears);
            } else if (type === 'part') {
                updateFilterDropdown('part', availableOptions, selectedParts);
            }
        }
        
        // 更新篩選器下拉選單
        function updateFilterDropdown(type, availableOptions, selectedSet) {
            let dropdown, toggleElement;
            
            if (type === 'year') {
                dropdown = yearFilterDropdown;
                toggleElement = yearFilterToggle;
            } else if (type === 'part') {
                dropdown = partFilterDropdown;
                toggleElement = partFilterToggle;
            } else {
                return;
            }
            
            // 設定更新標誌，防止無限循環
            isUpdatingFilters = true;
            
            try {
                // 儲存當前的選擇狀態
                const currentSelections = new Set(selectedSet);
                
                // 清空並重建下拉選單
                dropdown.innerHTML = '';
                
                availableOptions.forEach(option => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'multiselect-option';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = option;
                    checkbox.checked = currentSelections.has(option);
                    
                    if (type === 'year') {
                        checkbox.id = `year-${option}`;
                        checkbox.addEventListener('change', () => updateMultiselect('year'));
                    } else if (type === 'part') {
                        const partId = option.replace(/\s+/g, '-');
                        checkbox.id = `part-${partId}`;
                        checkbox.addEventListener('change', () => updateMultiselect('part'));
                    }
                    
                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    label.textContent = option;
                    
                    optionDiv.appendChild(checkbox);
                    optionDiv.appendChild(label);
                    dropdown.appendChild(optionDiv);
                });
                
                // 更新按鈕顯示文字
                updateFilterToggleText(type, availableOptions.length);
                
                // 檢查是否有選項被移除（因為與其他篩選器不相容）
                const removedSelections = [...currentSelections].filter(selection => 
                    !availableOptions.includes(selection)
                );
                
                if (removedSelections.length > 0) {
                    // 移除不相容的選項
                    removedSelections.forEach(selection => selectedSet.delete(selection));
                    console.log(`已移除不相容的${type === 'year' ? '年份' : '題型'}選項: ${removedSelections.join(', ')}`);
                }
            } finally {
                // 確保標誌被重置
                isUpdatingFilters = false;
            }
        }

        function updateFilters(data) {
            if (data.length === 0) {
                filterContainer.style.display = 'none';
                yearFilterToggle.setAttribute('disabled', true);
                partFilterToggle.setAttribute('disabled', true);
                return;
            }

            filterContainer.style.display = 'block';
            yearFilterToggle.removeAttribute('disabled');
            partFilterToggle.removeAttribute('disabled');
            
            // 確保桌面版的篩選器內容顯示正確
            if (window.innerWidth >= 600) {
                filterContent.style.display = 'block';
            }

            // 初始化時，所有選項都可用
            const availableYears = getAvailableOptions('year', data);
            const availableParts = getAvailableOptions('part', data);

            // 更新兩個篩選器
            updateFilterDropdown('year', availableYears, selectedYears);
            updateFilterDropdown('part', availableParts, selectedParts);
        }
 
        // 詞形變化規則和詞幹提取功能
        const morphologyRules = {
            // 複數規則
            plurals: [
                { pattern: /ies$/, replacement: 'y' },        // cities -> city
                { pattern: /ves$/, replacement: 'f' },        // lives -> life
                { pattern: /ves$/, replacement: 'fe' },       // knives -> knife
                { pattern: /ses$/, replacement: 's' },        // glasses -> glass
                { pattern: /ches$/, replacement: 'ch' },      // watches -> watch
                { pattern: /shes$/, replacement: 'sh' },      // dishes -> dish
                { pattern: /xes$/, replacement: 'x' },        // boxes -> box
                { pattern: /oes$/, replacement: 'o' },        // heroes -> hero
                { pattern: /s$/, replacement: '' },           // cats -> cat
            ],
            // 動詞變化規則
            verbs: [
                // 過去式和過去分詞
                { pattern: /ied$/, replacement: 'y' },        // studied -> study
                { pattern: /ed$/, replacement: '' },          // walked -> walk
                { pattern: /ed$/, replacement: 'e' },         // liked -> like
                { pattern: /(.)ed$/, replacement: '$1' },     // stopped -> stop
                
                // 現在分詞
                { pattern: /ying$/, replacement: 'y' },       // studying -> study
                { pattern: /ing$/, replacement: '' },         // walking -> walk
                { pattern: /ing$/, replacement: 'e' },        // liking -> like
                { pattern: /(.)ing$/, replacement: '$1' },    // stopping -> stop
                
                // 第三人稱單數
                { pattern: /ies$/, replacement: 'y' },        // flies -> fly
                { pattern: /es$/, replacement: '' },          // goes -> go
                { pattern: /s$/, replacement: '' },           // walks -> walk
            ],
            // 形容詞比較級和最高級
            adjectives: [
                { pattern: /iest$/, replacement: 'y' },       // happiest -> happy
                { pattern: /est$/, replacement: '' },         // tallest -> tall
                { pattern: /(.)est$/, replacement: '$1' },    // biggest -> big
                { pattern: /ier$/, replacement: 'y' },        // happier -> happy
                { pattern: /er$/, replacement: '' },          // taller -> tall
                { pattern: /(.)er$/, replacement: '$1' },     // bigger -> big
            ],
            // 副詞
            adverbs: [
                { pattern: /ly$/, replacement: '' },          // quickly -> quick
                { pattern: /ily$/, replacement: 'y' },        // happily -> happy
            ]
        };

        // 不規則動詞表
        const irregularVerbs = {
            'was': ['be', 'is', 'am', 'are', 'been', 'being'],
            'were': ['be', 'is', 'am', 'are', 'been', 'being'],
            'been': ['be', 'is', 'am', 'are', 'was', 'were', 'being'],
            'being': ['be', 'is', 'am', 'are', 'was', 'were', 'been'],
            'went': ['go', 'goes', 'going', 'gone'],
            'gone': ['go', 'goes', 'going', 'went'],
            'did': ['do', 'does', 'doing', 'done'],
            'done': ['do', 'does', 'doing', 'did'],
            'had': ['have', 'has', 'having'],
            'took': ['take', 'takes', 'taking', 'taken'],
            'taken': ['take', 'takes', 'taking', 'took'],
            'gave': ['give', 'gives', 'giving', 'given'],
            'given': ['give', 'gives', 'giving', 'gave'],
            'came': ['come', 'comes', 'coming'],
            'saw': ['see', 'sees', 'seeing', 'seen'],
            'seen': ['see', 'sees', 'seeing', 'saw'],
            'got': ['get', 'gets', 'getting', 'gotten'],
            'gotten': ['get', 'gets', 'getting', 'got'],
            'made': ['make', 'makes', 'making'],
            'said': ['say', 'says', 'saying'],
            'thought': ['think', 'thinks', 'thinking'],
            'found': ['find', 'finds', 'finding'],
            'knew': ['know', 'knows', 'knowing', 'known'],
            'known': ['know', 'knows', 'knowing', 'knew'],
            'left': ['leave', 'leaves', 'leaving'],
            'felt': ['feel', 'feels', 'feeling'],
            'kept': ['keep', 'keeps', 'keeping'],
            'told': ['tell', 'tells', 'telling'],
            'heard': ['hear', 'hears', 'hearing'],
            'brought': ['bring', 'brings', 'bringing'],
            'bought': ['buy', 'buys', 'buying'],
            'taught': ['teach', 'teaches', 'teaching'],
            'caught': ['catch', 'catches', 'catching'],
            'fought': ['fight', 'fights', 'fighting'],
            'wrote': ['write', 'writes', 'writing', 'written'],
            'written': ['write', 'writes', 'writing', 'wrote'],
            'rode': ['ride', 'rides', 'riding', 'ridden'],
            'ridden': ['ride', 'rides', 'riding', 'rode'],
            'drove': ['drive', 'drives', 'driving', 'driven'],
            'driven': ['drive', 'drives', 'driving', 'drove'],
            'spoke': ['speak', 'speaks', 'speaking', 'spoken'],
            'spoken': ['speak', 'speaks', 'speaking', 'spoke'],
            'chose': ['choose', 'chooses', 'choosing', 'chosen'],
            'chosen': ['choose', 'chooses', 'choosing', 'chose'],
            'broke': ['break', 'breaks', 'breaking', 'broken'],
            'broken': ['break', 'breaks', 'breaking', 'broke'],
            'wore': ['wear', 'wears', 'wearing', 'worn'],
            'worn': ['wear', 'wears', 'wearing', 'wore'],
            'threw': ['throw', 'throws', 'throwing', 'thrown'],
            'thrown': ['throw', 'throws', 'throwing', 'threw']
        };

        // 檢查規則是否會縮短單字
        function isShortening(rule, originalWord) {
            // 計算套用規則後的長度變化
            const match = originalWord.match(rule.pattern);
            if (!match) return false;
            
            const originalLength = match[0].length;
            const replacementLength = rule.replacement.length;
            return replacementLength < originalLength;
        }

        // 基本英文詞典（常用單字）
        const basicDictionary = new Set([
            // 常見短單字
            'a', 'an', 'as', 'at', 'be', 'by', 'do', 'go', 'he', 'i', 'if', 'in', 'is', 'it', 'me', 'my', 'no', 'of', 'on', 'or', 'so', 'to', 'up', 'we',
            // 常見動詞
            'am', 'are', 'was', 'were', 'been', 'being', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'can', 'could', 'may', 'might', 'must', 'shall', 'should',
            'get', 'got', 'give', 'gave', 'given', 'go', 'goes', 'went', 'gone', 'come', 'came', 'take', 'took', 'taken', 'see', 'saw', 'seen', 'know', 'knew', 'known',
            'think', 'thought', 'say', 'said', 'tell', 'told', 'make', 'made', 'find', 'found', 'want', 'like', 'look', 'use', 'work', 'try', 'ask', 'need', 'feel', 'felt',
            'seem', 'leave', 'left', 'put', 'mean', 'meant', 'keep', 'kept', 'let', 'begin', 'began', 'begun', 'help', 'show', 'showed', 'shown', 'hear', 'heard',
            'play', 'run', 'ran', 'move', 'live', 'believe', 'bring', 'brought', 'happen', 'write', 'wrote', 'written', 'sit', 'sat', 'stand', 'stood', 'lose', 'lost',
            'pay', 'paid', 'meet', 'met', 'include', 'continue', 'set', 'learn', 'learned', 'learnt', 'change', 'lead', 'led', 'understand', 'understood', 'watch', 'follow',
            'stop', 'stopped', 'create', 'speak', 'spoke', 'spoken', 'read', 'allow', 'add', 'spend', 'spent', 'grow', 'grew', 'grown', 'open', 'walk', 'win', 'won',
            'offer', 'remember', 'love', 'consider', 'appear', 'buy', 'bought', 'wait', 'serve', 'die', 'died', 'send', 'sent', 'expect', 'build', 'built', 'stay',
            'fall', 'fell', 'fallen', 'cut', 'reach', 'kill', 'remain', 'suggest', 'raise', 'pass', 'sell', 'sold', 'require', 'report', 'decide', 'pull',
            // 常見名詞
            'time', 'person', 'year', 'way', 'day', 'thing', 'man', 'world', 'life', 'hand', 'part', 'child', 'eye', 'woman', 'place', 'work', 'week', 'case', 'point',
            'government', 'company', 'number', 'group', 'problem', 'fact', 'water', 'money', 'story', 'month', 'book', 'home', 'school', 'house', 'car', 'job', 'word',
            'business', 'issue', 'side', 'kind', 'head', 'house', 'service', 'friend', 'father', 'power', 'hour', 'game', 'line', 'end', 'member', 'law', 'country',
            'family', 'student', 'idea', 'body', 'information', 'back', 'parent', 'face', 'others', 'level', 'office', 'door', 'health', 'person', 'art', 'war',
            'history', 'party', 'result', 'change', 'morning', 'reason', 'research', 'girl', 'guy', 'moment', 'air', 'teacher', 'force', 'education',
            // 常見形容詞
            'good', 'better', 'best', 'new', 'first', 'last', 'long', 'great', 'little', 'own', 'other', 'old', 'right', 'big', 'high', 'different', 'small',
            'large', 'next', 'early', 'young', 'important', 'few', 'public', 'bad', 'worse', 'worst', 'same', 'able', 'white', 'black', 'red', 'blue', 'green',
            'easy', 'hard', 'free', 'full', 'true', 'false', 'happy', 'sad', 'nice', 'beautiful', 'strong', 'weak', 'hot', 'cold', 'warm', 'cool', 'fast', 'slow'
        ]);

        // 檢查是否為有效英文單字
        function isValidWord(word) {
            const lowerWord = word.toLowerCase();
            // 基本詞典檢查
            if (basicDictionary.has(lowerWord)) return true;
            
            // 長度檢查：過短或過長的可能不是有效單字
            if (lowerWord.length < 1 || lowerWord.length > 20) return false;
            
            // 基本字母檢查
            if (!/^[a-z]+$/.test(lowerWord)) return false;
            
            // 使用 compromise.js 進行詞性檢測
            try {
                const doc = nlp(lowerWord);
                const tags = doc.out('tags');
                // 如果有詞性標籤，認為是有效單字
                return tags && tags.length > 0 && tags[0] && Object.keys(tags[0]).length > 0;
            } catch (e) {
                // 如果 compromise.js 出錯，使用基本驗證
                return lowerWord.length >= 2;
            }
        }

        // 檢測單字詞性
        function getPartOfSpeech(word) {
            try {
                const doc = nlp(word);
                const terms = doc.terms().out('array');
                if (terms.length === 0) return 'unknown';
                
                const term = doc.terms().get(0);
                if (term.has('#Verb')) return 'verb';
                if (term.has('#Noun')) return 'noun';
                if (term.has('#Adjective')) return 'adjective';
                if (term.has('#Adverb')) return 'adverb';
                if (term.has('#Preposition')) return 'preposition';
                if (term.has('#Pronoun')) return 'pronoun';
                if (term.has('#Determiner')) return 'determiner';
                
                return 'unknown';
            } catch (e) {
                return 'unknown';
            }
        }

        // 生成單字的所有可能變化形式（智能改善版）
        function generateWordVariations(word) {
            const variations = new Set([word.toLowerCase()]);
            const lowerWord = word.toLowerCase();
            
            // 🔍 第一層驗證：檢查是否為有效英文單字
            if (!isValidWord(lowerWord)) {
                console.log(`⚠️  "${word}" 可能不是有效的英文單字，僅返回原始形式`);
                return [lowerWord];
            }

            // 🎯 第二層改善：詞性檢測
            const partOfSpeech = getPartOfSpeech(lowerWord);
            const isShortWord = lowerWord.length < 3;
            
            console.log(`🔍 分析單字 "${word}": 詞性=${partOfSpeech}, 長度=${lowerWord.length}, 短單字=${isShortWord}`);
            
            // 檢查不規則動詞
            if (irregularVerbs[lowerWord]) {
                irregularVerbs[lowerWord].forEach(variant => variations.add(variant));
            }
            
            // 反向查找不規則動詞
            for (const [irregularForm, baseVariants] of Object.entries(irregularVerbs)) {
                if (baseVariants.includes(lowerWord)) {
                    variations.add(irregularForm);
                    baseVariants.forEach(variant => variations.add(variant));
                }
            }

            // 應用形態學規則（智能化處理）
            Object.values(morphologyRules).forEach(ruleSet => {
                ruleSet.forEach(rule => {
                    if (rule.pattern.test(lowerWord)) {
                        // 🚫 短單字跳過縮短規則
                        if (isShortWord && isShortening(rule, lowerWord)) {
                            return; // 跳過這個規則
                        }
                        
                        const stem = lowerWord.replace(rule.pattern, rule.replacement);
                        variations.add(stem);
                        
                        // 從詞幹生成其他形式
                        generateFormsFromStem(stem, isShortWord, partOfSpeech).forEach(form => variations.add(form));
                    }
                });
            });

            // 從原始單字生成其他形式
            generateFormsFromStem(lowerWord, isShortWord, partOfSpeech).forEach(form => variations.add(form));

            // 🗂️ 第三層驗證：過濾無效的變化形式
            const validVariations = Array.from(variations).filter(variant => {
                // 保留原始單字
                if (variant === lowerWord) return true;
                // 檢查不規則動詞
                if (Object.keys(irregularVerbs).includes(variant)) return true;
                if (Object.values(irregularVerbs).some(variants => variants.includes(variant))) return true;
                // 檢查其他變化是否為有效單字
                return isValidWord(variant);
            });

            console.log(`✅ "${word}" 生成 ${validVariations.length} 個有效變化:`, validVariations);
            return validVariations;
        }

        // 從詞幹生成各種變化形式（智能改善版，基於詞性的精確生成）
        function generateFormsFromStem(stem, isShortWord = false, partOfSpeech = 'unknown') {
            const forms = new Set([stem]);
            
            // 🎯 基於詞性的智能變化生成
            switch (partOfSpeech) {
                case 'noun':
                    // 名詞：主要生成複數形式
                    forms.add(stem + 's');
                    forms.add(stem + 'es');
                    if (stem.endsWith('y') && !isShortWord) {
                        forms.add(stem.slice(0, -1) + 'ies');
                    }
                    if (stem.endsWith('f') && !isShortWord) {
                        forms.add(stem.slice(0, -1) + 'ves');
                    }
                    if (stem.endsWith('fe') && !isShortWord) {
                        forms.add(stem.slice(0, -2) + 'ves');
                    }
                    break;
                    
                case 'verb':
                    // 動詞：生成時態變化
                    forms.add(stem + 'ed');
                    forms.add(stem + 'ing');
                    forms.add(stem + 's'); // 第三人稱單數
                    
                    if (stem.endsWith('e')) {
                        forms.add(stem + 'd');
                        if (!isShortWord) {
                            forms.add(stem.slice(0, -1) + 'ing');
                        }
                    }
                    if (stem.endsWith('y') && !isShortWord) {
                        forms.add(stem.slice(0, -1) + 'ied');
                        forms.add(stem.slice(0, -1) + 'ying');
                    }
                    
                    // 雙寫輔音字母的規則
                    if (stem.length >= 3 && /[bcdfghjklmnpqrstvwxyz]$/.test(stem) && 
                        /[aeiou][bcdfghjklmnpqrstvwxyz]$/.test(stem)) {
                        const doubled = stem + stem.slice(-1);
                        forms.add(doubled + 'ed');
                        forms.add(doubled + 'ing');
                    }
                    break;
                    
                case 'adjective':
                    // 形容詞：生成比較級和最高級
                    forms.add(stem + 'er');
                    forms.add(stem + 'est');
                    forms.add(stem + 'ly'); // 副詞形式
                    
                    if (stem.endsWith('y') && !isShortWord) {
                        forms.add(stem.slice(0, -1) + 'ier');
                        forms.add(stem.slice(0, -1) + 'iest');
                        forms.add(stem.slice(0, -1) + 'ily');
                    }
                    break;
                    
                case 'adverb':
                    // 副詞：通常變化較少
                    if (stem.endsWith('ly')) {
                        // 如果已經是副詞形式，嘗試還原形容詞
                        const adjBase = stem.slice(0, -2);
                        if (adjBase.length > 2) {
                            forms.add(adjBase);
                        }
                    }
                    break;
                    
                default:
                    // 未知詞性：生成所有可能的變化，但更保守
                    if (!isShortWord) {
                        // 只對非短單字進行全面變化
                        forms.add(stem + 's');
                        forms.add(stem + 'ed');
                        forms.add(stem + 'ing');
                        forms.add(stem + 'er');
                        forms.add(stem + 'est');
                        forms.add(stem + 'ly');
                        
                        if (stem.endsWith('y')) {
                            forms.add(stem.slice(0, -1) + 'ies');
                            forms.add(stem.slice(0, -1) + 'ied');
                        }
                    } else {
                        // 短單字只添加基本擴展
                        forms.add(stem + 's');
                        forms.add(stem + 'ed');
                        forms.add(stem + 'ing');
                    }
            }

            return Array.from(forms);
        }



        // 重置篩選器狀態
        function resetFilters() {
            selectedYears.clear();
            selectedParts.clear();
        }

        // 處理單字搜尋
        function handleWordSearch() {
            if (!isDataLoaded) return;
            
            const wordTerm = wordSearchInput.value.trim();
            
            if (!wordTerm) {
                searchModeIndicator.style.display = 'none';
                resultsTable.style.display = 'none';
                resultsInfo.style.display = 'none';
                noResults.style.display = 'none';
                filterContainer.style.display = 'none';
                wordSearchResults = [];
                filteredData = [];
                resetFilters(); // 清空搜尋時也重置篩選器
                return;
            }
 
            // 每次進行新搜尋時重置篩選器狀態
            resetFilters();
            
            const variations = generateWordVariations(wordTerm);
            searchModeIndicator.style.display = 'block';
            searchModeIndicator.textContent = `正在 VocabGem 中搜尋「${wordTerm}」💎 涵蓋 ${variations.length} 種詞形變化，為您挖掘珍貴的學習寶石`;

            wordSearchResults = allData.filter(item => {
                const sentence = item.sentence.toLowerCase();
                return variations.some(variation => {
                    const regex = new RegExp(`\\b${escapeRegExp(variation)}\\b`, 'i');
                    return regex.test(sentence);
                });
            });

            updateFilters(wordSearchResults);
 
            // 應用篩選器
            applyFilters();
        }

        // 轉義正則表達式特殊字符
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // 複製單個句子功能
        async function copySentence(sentence, button) {
            try {
                await navigator.clipboard.writeText(sentence);
                
                // 更新按鈕狀態
                const originalIcon = button.innerHTML;
                button.innerHTML = '<span class="material-symbols-outlined">check</span>';
                button.classList.add('copied');
                
                // 2秒後恢復原狀
                setTimeout(() => {
                    button.innerHTML = originalIcon;
                    button.classList.remove('copied');
                }, 2000);
                
            } catch (err) {
                console.error('複製失敗:', err);
                
                // 如果複製失敗，顯示錯誤狀態
                const originalIcon = button.innerHTML;
                button.innerHTML = '<span class="material-symbols-outlined">error</span>';
                button.style.color = 'var(--md-sys-color-error)';
                
                setTimeout(() => {
                    button.innerHTML = originalIcon;
                    button.style.color = '';
                }, 2000);
            }
        }



        // 切換下載選單
        function toggleDownloadMenu() {
            const isVisible = downloadMenu.style.display === 'block';
            downloadMenu.style.display = isVisible ? 'none' : 'block';
        }

        // 緊湊模式切換功能
        function toggleCompactMode() {
            const body = document.body;
            const compactIcon = compactToggle.querySelector('.material-symbols-outlined');
            const isCompact = body.classList.contains('compact-mode');
            
            if (isCompact) {
                // 關閉緊湊模式
                body.classList.remove('compact-mode');
                compactIcon.textContent = 'compress';
                compactToggle.title = '切換緊湊檢視模式';
                
                // 記住使用者偏好
                localStorage.setItem('VocabGem_compactMode', 'false');
            } else {
                // 開啟緊湊模式
                body.classList.add('compact-mode');
                compactIcon.textContent = 'expand';
                compactToggle.title = '切換正常檢視模式';
                
                // 記住使用者偏好
                localStorage.setItem('VocabGem_compactMode', 'true');
            }
        }

        // 初始化緊湊模式偏好設定
        function initializeCompactMode() {
            const savedCompactMode = localStorage.getItem('VocabGem_compactMode');
            if (savedCompactMode === 'true') {
                document.body.classList.add('compact-mode');
                const compactIcon = compactToggle.querySelector('.material-symbols-outlined');
                compactIcon.textContent = 'expand';
                compactToggle.title = '切換正常檢視模式';
            }
        }

        // 下載功能
        function downloadData(format) {
            if (!filteredData || filteredData.length === 0) {
                alert('沒有可下載的結果');
                return;
            }

            downloadMenu.style.display = 'none';

            const headers = ['年份', '題型', '來源', '例句 (English)', '例句翻譯 (中文)'];
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
            
            if (format === 'markdown') {
                downloadMarkdown(headers, filteredData, timestamp);
            } else if (format === 'tsv') {
                downloadTSV(headers, filteredData, timestamp);
            } else if (format === 'excel') {
                downloadExcel(headers, filteredData, timestamp);
            } else if (format === 'word') {
                downloadWord(headers, filteredData, timestamp);
            }
        }

        // 下載 Markdown 格式
        function downloadMarkdown(headers, data, timestamp) {
            const separator = '|' + headers.map(() => '---').join('|') + '|';
            const headerRow = '|' + headers.join('|') + '|';
            const dataRows = data.map(item => 
                `|${item.year}|${item.part}|${item.source}|${item.sentence}|${item.translation}|`
            );

            const content = [headerRow, separator, ...dataRows].join('\n');
            downloadFile(content, `vocabulary_results_${timestamp}.md`, 'text/markdown');
        }

        // 下載 TSV 格式
        function downloadTSV(headers, data, timestamp) {
            const rows = data.map(item => [
                item.year,
                item.part,
                item.source,
                item.sentence,
                item.translation
            ]);

            const content = [headers, ...rows]
                .map(row => row.map(cell => `"${String(cell || '').replace(/"/g, '""')}"`).join('\t'))
                .join('\n');

            downloadFile(content, `vocabulary_results_${timestamp}.tsv`, 'text/tab-separated-values');
        }

        // 下載 Excel 格式 (.xlsx)
        function downloadExcel(headers, data, timestamp) {
            try {
                // 準備資料陣列，第一行是標題
                const worksheetData = [headers];
                
                // 加入資料行
                data.forEach(item => {
                    worksheetData.push([
                        String(item.year || ''),
                        String(item.part || ''),
                        String(item.source || ''),
                        String(item.sentence || ''),
                        String(item.translation || '')
                    ]);
                });

                // 建立工作表
                const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);

                // 設定欄寬
                const columnWidths = [
                    { wch: 8 },   // 年份
                    { wch: 15 },  // 題型
                    { wch: 12 },  // 來源
                    { wch: 50 },  // 英文句子
                    { wch: 50 }   // 中文翻譯
                ];
                worksheet['!cols'] = columnWidths;

                // 建立工作簿
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, '詞彙搜尋結果');

                // 下載檔案
                const filename = `vocabulary_results_${timestamp}.xlsx`;
                XLSX.writeFile(workbook, filename);

            } catch (error) {
                console.error('生成 Excel 檔案時發生錯誤:', error);
                alert('生成 Excel 檔案時發生錯誤，請稍後再試');
            }
        }

        // 下載 Word 格式 (.docx) - 對話式排列格式
        function downloadWord(headers, data, timestamp) {
            try {
                // 檢查 docx 是否已載入
                if (typeof docx === 'undefined' && typeof window.docx === 'undefined') {
                    console.error('docx 函式庫未載入');
                    alert('Word 文件生成功能暫時無法使用，請重新載入頁面後再試');
                    return;
                }
                
                // 使用正確的 docx 參考
                const docxLib = window.docx || docx;

                // 建立文件段落陣列
                const paragraphs = [];

                // 新增標題
                paragraphs.push(
                    new docxLib.Paragraph({
                        children: [
                            new docxLib.TextRun({
                                text: "VocabGem 詞彙寶石挖掘結果",
                                bold: true,
                                size: 32, // 16pt
                            }),
                        ],
                        alignment: docxLib.AlignmentType.CENTER,
                        spacing: {
                            after: 400,
                        },
                    })
                );

                // 新增生成時間
                const now = new Date();
                const dateStr = now.toLocaleDateString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                paragraphs.push(
                    new docxLib.Paragraph({
                        children: [
                            new docxLib.TextRun({
                                text: `生成時間：${dateStr}`,
                                italics: true,
                                size: 20, // 10pt
                            }),
                        ],
                        alignment: docxLib.AlignmentType.CENTER,
                        spacing: {
                            after: 600,
                        },
                    })
                );

                // 新增結果總數
                paragraphs.push(
                    new docxLib.Paragraph({
                        children: [
                            new docxLib.TextRun({
                                text: `共找到 ${data.length} 個學測真題例句`,
                                bold: true,
                                size: 24, // 12pt
                            }),
                        ],
                        spacing: {
                            after: 400,
                        },
                    })
                );

                // 新增分隔線
                paragraphs.push(
                    new docxLib.Paragraph({
                        children: [
                            new docxLib.TextRun({
                                text: "═══════════════════════════════════════════════════════════════",
                                size: 20,
                            }),
                        ],
                        spacing: {
                            after: 400,
                        },
                    })
                );

                // 遍歷每筆資料，使用對話式格式
                data.forEach((item, index) => {
                    // 編號和英文句子
                    paragraphs.push(
                        new docxLib.Paragraph({
                            children: [
                                new docxLib.TextRun({
                                    text: `${index + 1}. 例句：`,
                                    bold: true,
                                    size: 22, // 11pt
                                }),
                                new docxLib.TextRun({
                                    text: item.sentence,
                                    size: 22,
                                }),
                            ],
                            spacing: {
                                after: 200,
                            },
                        })
                    );

                    // 中文翻譯
                    paragraphs.push(
                        new docxLib.Paragraph({
                            children: [
                                new docxLib.TextRun({
                                    text: "   翻譯：",
                                    bold: true,
                                    size: 22,
                                }),
                                new docxLib.TextRun({
                                    text: item.translation,
                                    size: 22,
                                }),
                            ],
                            spacing: {
                                after: 200,
                            },
                        })
                    );

                    // 來源資訊
                    paragraphs.push(
                        new docxLib.Paragraph({
                            children: [
                                new docxLib.TextRun({
                                    text: `   【${item.year}年 ${item.part} ${item.source}】`,
                                    italics: true,
                                    size: 20,
                                    color: "666666",
                                }),
                            ],
                            spacing: {
                                after: 400,
                            },
                        })
                    );

                    // 如果不是最後一筆，加入分隔線
                    if (index < data.length - 1) {
                        paragraphs.push(
                            new docxLib.Paragraph({
                                children: [
                                    new docxLib.TextRun({
                                        text: "",
                                    }),
                                ],
                                spacing: {
                                    after: 200,
                                },
                            })
                        );
                    }
                });

                // 建立文件
                const doc = new docxLib.Document({
                    sections: [{
                        properties: {
                            page: {
                                margin: {
                                    top: 1440, // 1 inch
                                    right: 1440,
                                    bottom: 1440,
                                    left: 1440,
                                },
                            },
                        },
                        children: paragraphs,
                    }],
                });

                // 生成並下載檔案
                const filename = `vocabulary_results_${timestamp}.docx`;
                docxLib.Packer.toBlob(doc).then(blob => {
                    saveAs(blob, filename);
                }).catch(error => {
                    console.error('生成 Word 檔案時發生錯誤:', error);
                    alert('生成 Word 檔案時發生錯誤，請稍後再試');
                });

            } catch (error) {
                console.error('生成 Word 檔案時發生錯誤:', error);
                alert('生成 Word 檔案時發生錯誤，請稍後再試');
            }
        }

        // 通用下載文件函數
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // 帶高亮的資料顯示函數
        function displayDataWithHighlight(data, highlightWords) {
            if (data.length === 0) {
                resultsTable.style.display = 'none';
                resultsInfo.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }

            noResults.style.display = 'none';
            resultsTable.style.display = 'table';
            resultsInfo.style.display = 'block';
            resultsCount.textContent = `找到 ${data.length} 個學測真題例句`;

            // 清空表格
            resultsBody.innerHTML = '';

            // 填充資料
            data.forEach(item => {
                const row = document.createElement('tr');

                const yearCell = document.createElement('td');
                const yearBadge = document.createElement('span');
                yearBadge.classList.add('year-badge');
                yearBadge.textContent = item.year;
                yearCell.appendChild(yearBadge);
                row.appendChild(yearCell);

                const partCell = document.createElement('td');
                const partBadge = document.createElement('span');
                partBadge.classList.add('part-badge');
                partBadge.textContent = item.part;
                partBadge.title = item.part;
                partCell.appendChild(partBadge);
                row.appendChild(partCell);

                const sourceCell = document.createElement('td');
                sourceCell.textContent = item.source;
                row.appendChild(sourceCell);

                const sentenceCell = document.createElement('td');
                sentenceCell.classList.add('sentence-cell');
                
                // 創建句子內容容器
                const sentenceContent = document.createElement('div');
                sentenceContent.classList.add('sentence-content');
                
                // 創建句子文字容器
                const sentenceText = document.createElement('div');
                sentenceText.classList.add('sentence-text');
                sentenceText.innerHTML = highlightText(item.sentence, highlightWords);
                
                // 創建複製按鈕
                const copyButton = document.createElement('button');
                copyButton.classList.add('copy-sentence-btn');
                copyButton.innerHTML = '<span class="material-symbols-outlined">content_copy</span>';
                copyButton.title = '複製例句';
                copyButton.addEventListener('click', () => copySentence(item.sentence, copyButton));
                
                sentenceContent.appendChild(sentenceText);
                sentenceContent.appendChild(copyButton);
                sentenceCell.appendChild(sentenceContent);
                row.appendChild(sentenceCell);

                const translationCell = document.createElement('td');
                translationCell.classList.add('translation-cell');
                translationCell.textContent = item.translation;
                row.appendChild(translationCell);

                resultsBody.appendChild(row);
            });
        }

        // 高亮文字函數
        function highlightText(text, words) {
            let highlightedText = text;
            
            words.forEach(word => {
                if (word.length > 0) {
                    const regex = new RegExp(`\\b(${escapeRegExp(word)})\\b`, 'gi');
                    highlightedText = highlightedText.replace(regex, '<span class="word-match">$1</span>');
                }
            });
            
            return highlightedText;
        }

        function displayData(data) {
            if (data.length === 0) {
                resultsTable.style.display = 'none';
                resultsInfo.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }

            noResults.style.display = 'none';
            resultsTable.style.display = 'table';
            resultsInfo.style.display = 'block';
            resultsCount.textContent = `找到 ${data.length} 個學測真題例句`;

            // 清空表格
            resultsBody.innerHTML = '';

            // 填充資料
            data.forEach(item => {
                const row = document.createElement('tr');

                const yearCell = document.createElement('td');
                const yearBadge = document.createElement('span');
                yearBadge.classList.add('year-badge');
                yearBadge.textContent = item.year;
                yearCell.appendChild(yearBadge);
                row.appendChild(yearCell);

                const partCell = document.createElement('td');
                const partBadge = document.createElement('span');
                partBadge.classList.add('part-badge');
                partBadge.textContent = item.part;
                partBadge.title = item.part;
                partCell.appendChild(partBadge);
                row.appendChild(partCell);

                const sourceCell = document.createElement('td');
                sourceCell.textContent = item.source;
                row.appendChild(sourceCell);

                const sentenceCell = document.createElement('td');
                sentenceCell.classList.add('sentence-cell');
                
                // 創建句子內容容器
                const sentenceContent = document.createElement('div');
                sentenceContent.classList.add('sentence-content');
                
                // 創建句子文字容器
                const sentenceText = document.createElement('div');
                sentenceText.classList.add('sentence-text');
                sentenceText.textContent = item.sentence;
                
                // 創建複製按鈕
                const copyButton = document.createElement('button');
                copyButton.classList.add('copy-sentence-btn');
                copyButton.innerHTML = '<span class="material-symbols-outlined">content_copy</span>';
                copyButton.title = '複製例句';
                copyButton.addEventListener('click', () => copySentence(item.sentence, copyButton));
                
                sentenceContent.appendChild(sentenceText);
                sentenceContent.appendChild(copyButton);
                sentenceCell.appendChild(sentenceContent);
                row.appendChild(sentenceCell);

                const translationCell = document.createElement('td');
                translationCell.classList.add('translation-cell');
                translationCell.textContent = item.translation;
                row.appendChild(translationCell);

                resultsBody.appendChild(row);
            });
        }

        function showLoading(show) {
            loading.style.display = show ? 'block' : 'none';
        }

        function updateStatus(message) {
            statusText.textContent = message;
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        // 防抖函數
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 移除這些函數，因為我們使用 Apps Script
        // async function fetchGoogleSheetsData() { ... }
        // function parseSheetData(sheetData) { ... }
    </script>

    <footer class="site-footer">
        <p>均一教育平台 x 鄭博仁老師</p>
    </footer>
</body>
</html>
